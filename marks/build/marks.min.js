var marks=document.getElementsByClassName("marks")[0],table=marks.getElementsByTagName("table")[0];if(void 0!==table){let e=document.querySelector(".marks > div > div"),t=table.querySelectorAll("tr:not(:nth-child(1)):not(:nth-child(2)) td span"),l=(table.getElementsByTagName("tr"),document.querySelector(".marks > div > ul:first-child")),a=document.querySelector(".marks > div > ul:last-child"),o=a.getElementsByTagName("li"),s=document.getElementById("scroll_left"),n=document.getElementById("scroll_right"),i=document.getElementById("period_start"),d=document.getElementById("period_end"),r=marks.getElementsByClassName("period_hidden_left")[0],c=marks.getElementsByClassName("period_hidden_right")[0],m=!1,f=document.getElementsByClassName("details")[0],h=!1;function show_details(e,t,l){h||(locate_details(e,t),f.innerHTML=l.getElementsByTagName("div")[0].innerHTML,f.classList.toggle("expired",l.classList.contains("expired")),f.classList.add("shown"))}function locate_details(e,t){h||(f.style.top=Math.min(document.documentElement.clientHeight-f.offsetHeight,t-html.scrollTop+20)+"px",f.style.left=Math.min(document.documentElement.clientWidth-f.offsetWidth,e-html.scrollLeft+20)+"px")}function hide_details(){h||f.classList.remove("shown")}function toggle_details_lock(e){let l=!0;for(let a of t)if(a.contains(e.target)){h=!1,show_details(e.pageX,e.pageY,a),h=!0,l=!1;break}l&&!f.contains(e.target)&&(h=!1,hide_details())}function onhashchange(){let t=decodeURIComponent(window.location.hash);if(t){let l=document.getElementById(t.slice(1)),a=l.parentElement.parentElement;a.classList.add("selected"),h=!1,show_details(l.getBoundingClientRect().left+html.scrollLeft+20,l.getBoundingClientRect().top+html.scrollTop+10,l),function t(){m?h=!0:(e.scrollLeft=a.offsetLeft-e.offsetWidth/2+a.offsetWidth/2,locate_details(l.getBoundingClientRect().left+html.scrollLeft+20,l.getBoundingClientRect().top+html.scrollTop+10),requestAnimationFrame(t))}()}else!function t(){m||(e.scrollLeft=e.scrollWidth,requestAnimationFrame(t))}()}function ScrollParametricBlend(e){return e*e/(1.85*e*(e-1)+1)}function scroll_table_to(t){let l=45,a=1/l,o=t-e.scrollLeft;!function s(){e.scrollLeft=t-ScrollParametricBlend(l*a)*o,l<=0?scroll_animation=!1:(--l,requestAnimationFrame(s))}()}function scroll_table_by(t){scroll_table_to(Math.min(e.scrollWidth-e.offsetWidth,Math.max(0,e.scrollLeft+t)))}function on_table_scroll(){s.classList.toggle("hidden",e.scrollLeft<=2),n.classList.toggle("hidden",e.scrollLeft>=e.scrollWidth-e.offsetWidth-2),l.classList.toggle("shadow",e.scrollLeft>2),a.classList.toggle("shadow",e.scrollLeft<e.scrollWidth-e.offsetWidth-2)}function apply_period(t=!1){if(!i.validity.valid||!d.validity.valid)return;let l=i.value,a=d.value,s=e.scrollWidth,n=0;l||(l=i.dataset.default,i.value=l),a||(a=d.dataset.default,d.value=a),l=new Date(l),a=new Date(a);for(let e=2;e<table.getElementsByTagName("tr").length;++e){let t=table.getElementsByTagName("tr")[e],i=0,d=0;for(let e of t.getElementsByTagName("td")){if(!e.classList.contains("filled"))continue;let t;for(let l of e.classList)if(t=new Date(l),t instanceof Date&&!isNaN(t))break;if(l<=t&&t<=a){s=Math.min(s,e.offsetLeft),n=Math.max(n,e.offsetLeft+e.offsetWidth);for(let t of e.getElementsByTagName("span"))t.dataset.mark&&t.dataset.rate&&(i+=Number(t.dataset.mark)*Number(t.dataset.rate),d+=Number(t.dataset.rate))}}d&&i?(i=Math.round(100*(i/d-.001))/100,o[e].innerHTML=i):o[e].innerHTML="-";for(let e of t.getElementsByTagName("td")){if(!e.classList.contains("filled"))continue;let t;for(let l of e.classList)if(t=new Date(l),t instanceof Date&&!isNaN(t))break;if(l<=t&&t<=a)for(let t of e.getElementsByTagName("span"))t.classList.toggle("high",t.dataset.mark&&t.dataset.mark>i);else for(let t of e.getElementsByTagName("span"))t.classList.remove("high")}}r.style.width=s+"px",c.style.left=n+"px",c.style.width=e.scrollWidth-n+"px",t&&ajax("POST","/src/set_diary_period.php",{period_start:l.getFullYear()+"-"+(l.getMonth()+1)+"-"+l.getDate(),period_end:a.getFullYear()+"-"+(a.getMonth()+1)+"-"+a.getDate()},e=>{"success"==e.responseText?console.log("Period saved"):(alert("Error"),alert(e.responseText))},e=>{alert("Error"),alert(e.responseText)})}Event.add(window,"load",()=>{Event.add(window,"hashchange",onhashchange);decodeURIComponent(window.location.hash);if(decodeURIComponent(window.location.hash))setTimeout(onhashchange);else{setTimeout((function t(){m||(e.scrollLeft=e.scrollWidth,on_table_scroll(),requestAnimationFrame(t))}))}body.append(f);for(let e of t)Event.add(e,"mouseenter",t=>{show_details(t.pageX,t.pageY,e)}),Event.add(e,"mouseleave",()=>{hide_details()}),Event.add(e,"mousemove",e=>{locate_details(e.pageX,e.pageY)});Event.add(window,"mousedown",toggle_details_lock),Event.add(s,"mousedown",()=>{scroll_table_by(-Math.round(.8*e.offsetWidth))}),Event.add(n,"mousedown",()=>{scroll_table_by(Math.round(.8*e.offsetWidth))}),Event.add(i,"change",()=>{apply_period(!0)}),Event.add(d,"change",()=>{apply_period(!0)}),setTimeout(apply_period),setTimeout(on_table_scroll),setTimeout(()=>{m=!0,Event.add(e,"scroll",on_table_scroll),setTimeout(apply_period)},150)})}