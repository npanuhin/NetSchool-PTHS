var marks=document.getElementsByClassName("marks")[0],table=marks.getElementsByTagName("table")[0],scroll_table=document.querySelector(".marks > div > div"),spans=table.querySelectorAll("tr:not(:nth-child(1)):not(:nth-child(2)) td span"),table_tr=table.getElementsByTagName("tr"),left_column=document.querySelector(".marks > div > ul:first-child"),right_column=document.querySelector(".marks > div > ul:last-child"),right_column_li=right_column.getElementsByTagName("li"),details_block=marks.getElementsByClassName("details")[0],scroll_left_button=document.getElementById("scroll_left"),scroll_right_button=document.getElementById("scroll_right"),period_start_input=document.getElementById("period_start"),period_end_input=document.getElementById("period_end"),period_hidden_left=marks.getElementsByClassName("period_hidden_left")[0],period_hidden_right=marks.getElementsByClassName("period_hidden_right")[0],table_unlocked=!1,details_lock=!1;function show_details(e,t,l){details_lock||(locate_details(e,t),details_block.innerHTML=l.getElementsByTagName("div")[0].innerHTML,details_block.classList.toggle("expired",l.classList.contains("expired")),details_block.classList.add("shown"))}function locate_details(e,t){details_lock||(details_block.style.top=Math.min((window.pageYOffset||document.scrollTop||0)-(document.clientTop||0)+document.documentElement.clientHeight-details_block.offsetHeight-20,t)-html.scrollTop+20+"px",details_block.style.left=Math.min((window.pageXOffset||document.scrollLeft||0)-(document.clientLeft||0)+document.documentElement.clientWidth-details_block.offsetWidth-20,e)+20+"px")}function hide_details(){details_lock||details_block.classList.remove("shown")}function toggle_details_lock(e){let t=!0;for(let l of spans)l==e.target&&(details_lock=!1,show_details(e.pageX,e.pageY,l),details_lock=!0,t=!1);t&&!details_block.contains(e.target)&&(details_lock=!1,hide_details())}function onhashchange(){let e=decodeURIComponent(window.location.hash);if(e){let t=document.getElementById(e.slice(1)),l=t.parentElement.parentElement;l.classList.add("selected"),details_lock=!1,show_details(t.getBoundingClientRect().left+html.scrollLeft+20,t.getBoundingClientRect().top+html.scrollTop+10,t),function e(){table_unlocked?details_lock=!0:(scroll_table.scrollLeft=l.offsetLeft-scroll_table.offsetWidth/2+l.offsetWidth/2,locate_details(t.getBoundingClientRect().left+html.scrollLeft+20,t.getBoundingClientRect().top+html.scrollTop+10),requestAnimationFrame(e))}()}else!function e(){table_unlocked||(scroll_table.scrollLeft=scroll_table.scrollWidth,requestAnimationFrame(e))}()}function ScrollParametricBlend(e){return e*e/(1.85*e*(e-1)+1)}function scroll_table_to(e){let t=45,l=1/t,o=e-scroll_table.scrollLeft;!function a(){scroll_table.scrollLeft=e-ScrollParametricBlend(t*l)*o,t<=0?scroll_animation=!1:(--t,requestAnimationFrame(a))}()}function scroll_table_by(e){scroll_table_to(Math.min(scroll_table.scrollWidth-scroll_table.offsetWidth,Math.max(0,scroll_table.scrollLeft+e)))}function on_table_scroll(){scroll_left_button.classList.toggle("hidden",scroll_table.scrollLeft<=2),scroll_right_button.classList.toggle("hidden",scroll_table.scrollLeft>=scroll_table.scrollWidth-scroll_table.offsetWidth-2),left_column.classList.toggle("shadow",scroll_table.scrollLeft>2),right_column.classList.toggle("shadow",scroll_table.scrollLeft<scroll_table.scrollWidth-scroll_table.offsetWidth-2)}function apply_period(e=!1){if(!period_start_input.validity.valid||!period_end_input.validity.valid)return;let t=period_start_input.value,l=period_end_input.value,o=scroll_table.scrollWidth,a=0;t||(t=period_start_input.dataset.default,period_start_input.value=t),l||(l=period_end_input.dataset.default,period_end_input.value=l),t=new Date(t),l=new Date(l);for(let e=2;e<table.getElementsByTagName("tr").length;++e){let s=table.getElementsByTagName("tr")[e],n=0,i=0;for(let e of s.getElementsByTagName("td")){if(!e.classList.contains("filled"))continue;let s;for(let t of e.classList)if(s=new Date(t),s instanceof Date&&!isNaN(s))break;if(t<=s&&s<=l){o=Math.min(o,e.offsetLeft),a=Math.max(a,e.offsetLeft+e.offsetWidth);for(let t of e.getElementsByTagName("span"))t.dataset.mark&&t.dataset.rate&&(n+=Number(t.dataset.mark)*Number(t.dataset.rate),i+=Number(t.dataset.rate))}}right_column_li[e].innerHTML=n&&i?Math.round(100*(n/i-.001))/100:"-"}period_hidden_left.style.width=o+"px",period_hidden_right.style.left=a+"px",period_hidden_right.style.width=scroll_table.scrollWidth-a+"px",e&&ajax("POST","/src/set_diary_period.php",{period_start:t.getFullYear()+"-"+(t.getMonth()+1)+"-"+t.getDate(),period_end:l.getFullYear()+"-"+(l.getMonth()+1)+"-"+l.getDate()},e=>{"success"==e.responseText?console.log("Period saved"):(alert("Error"),alert(e.responseText))},e=>{alert("Error"),alert(e.responseText)})}Event.add(window,"load",()=>{Event.add(window,"hashchange",onhashchange);decodeURIComponent(window.location.hash);if(decodeURIComponent(window.location.hash))setTimeout(onhashchange);else{setTimeout((function e(){table_unlocked||(scroll_table.scrollLeft=scroll_table.scrollWidth,on_table_scroll(),requestAnimationFrame(e))}))}for(let e of spans)Event.add(e,"mouseenter",t=>{show_details(t.pageX,t.pageY,e)}),Event.add(e,"mouseleave",()=>{hide_details()}),Event.add(e,"mousemove",e=>{locate_details(e.pageX,e.pageY)});Event.add(window,"mousedown",toggle_details_lock),Event.add(scroll_left_button,"mousedown",()=>{scroll_table_by(-Math.round(.8*scroll_table.offsetWidth))}),Event.add(scroll_right_button,"mousedown",()=>{scroll_table_by(Math.round(.8*scroll_table.offsetWidth))}),Event.add(period_start_input,"change",()=>{apply_period(!0)}),Event.add(period_end_input,"change",()=>{apply_period(!0)}),setTimeout(apply_period),setTimeout(on_table_scroll),setTimeout(()=>{table_unlocked=!0,Event.add(scroll_table,"scroll",on_table_scroll)},150)});